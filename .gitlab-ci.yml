image: beagle/sphinx-build-env:latest

stages:
  - deploy-main
  - deploy-branch
  - deploy-tag

pages:
  stage: deploy-main
  script:
  - sphinx-build -b html . public/latest/
  - sphinx-build -M latexpdf . public/latest/
  - mv public/latex/beagleboard-docs.pdf public/latest/
  - echo "/ /latest/ 302" > public/latest/_redirects
  artifacts:
    paths:
    - public
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      when: always

pages:
  stage: deploy-branch
  script:
  - sphinx-build -b html . public/$CI_COMMIT_BRANCH/
  - sphinx-build -M latexpdf . public/$CI_COMMIT_BRANCH/
  - mv public/latex/beagleboard-docs.pdf public/$CI_COMMIT_BRANCH/
  artifacts:
    paths:
    - public
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      when: never
    - if: $CI_COMMIT_BRANCH
      when: always

pages:
  stage: deploy-tag
  script:
  - export GIT_BRANCH=$(git branch -a --contains tags/$CI_COMMIT_TAG | grep origin | sed 's/.*origin\///'`
  - sphinx-build -b html . public/$GIT_BRANCH/
  - sphinx-build -M latexpdf . public/$GIT_BRANCH/
  - mv public/latex/beagleboard-docs.pdf public/$GIT_BRANCH/
  artifacts:
    paths:
    - public
  rules:
    - if: $CI_COMMIT_TAG
      when: always
